
# Kind Mind Learning - AI Tutor App

This is a Next.js application with a Firebase backend designed to be an AI-powered tutor, especially for neurodivergent learners.

## Firebase Backend Setup

This project uses Firebase for Authentication, Firestore, Storage, and Cloud Functions.

### 1. Firebase Project Setup

*   Go to the [Firebase Console](https://console.firebase.google.com/) and create a new project (or use an existing one).
*   Add a Web App to your Firebase project to get your Firebase SDK configuration snippet.
*   Enable the following Firebase services:
    *   **Authentication**: Enable Google, Email/Password, and Anonymous sign-in methods.
    *   **Firestore**: Create a Firestore database in Native mode.
    *   **Storage**: Enable Firebase Storage.
    *   **Functions**: You'll deploy Cloud Functions.

### 2. Install Firebase CLI

If you haven't already, install the Firebase CLI globally:
`npm install -g firebase-tools`

### 3. Login to Firebase

Login to your Firebase account through the CLI:
`firebase login`

### 4. Initialize Firebase in Your Project

If this is a new project directory, run:
`firebase init`

Select the following features:
*   Firestore: Configure Rules and Indexes files.
*   Functions: Choose TypeScript, use ESLint.
*   Hosting: Configure as a single-page app (if not using Next.js SSR with Firebase Hosting) or set up for Next.js. (The provided `firebase.json` assumes basic static hosting or SPA for the frontend if not using Next.js SSR via Firebase).
*   Storage: Configure Rules file.
*   Emulators: Optional, but recommended for local development.

If you already have a Firebase project and are just adding files:
*   Ensure your `.firebaserc` file correctly points to your Firebase project ID.
    ```json
    {
      "projects": {
        "default": "YOUR_FIREBASE_PROJECT_ID"
      }
    }
    ```
    Replace `YOUR_FIREBASE_PROJECT_ID` with your actual project ID. The one generated by Studio `kindmind-learning-app` might be a placeholder.

### 5. Environment Variables for Firebase SDK (Frontend)

Create a `.env.local` file in the root of your Next.js project (where `package.json` is) and add your Firebase Web App configuration:

```env
NEXT_PUBLIC_FIREBASE_API_KEY=your_api_key
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=your_auth_domain
NEXT_PUBLIC_FIREBASE_PROJECT_ID=your_project_id
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=your_storage_bucket
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=your_messaging_sender_id
NEXT_PUBLIC_FIREBASE_APP_ID=your_app_id
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=your_measurement_id (optional)

# For Stripe (Publishable Key for Frontend)
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_YOUR_STRIPE_PUBLISHABLE_KEY

# App URL (for Stripe redirects, etc.)
NEXT_PUBLIC_APP_URL=http://localhost:3000 
# For production, change to your deployed app URL
```

### 6. Environment Variables for Cloud Functions (Backend)

Cloud Functions require their own environment configuration for API keys (OpenAI/Gemini, Stripe Secret Key). **Do not commit these directly into your code.**

Use the Firebase CLI to set these:

```bash
# Replace with your actual keys
firebase functions:config:set openai.key="sk_YOUR_OPENAI_API_KEY"
firebase functions:config:set googleai.key="YOUR_GOOGLE_GENAI_API_KEY" # If using Genkit with Google AI
firebase functions:config:set stripe.secret_key="sk_test_YOUR_STRIPE_SECRET_KEY"
firebase functions:config:set stripe.webhook_secret="whsec_YOUR_STRIPE_WEBHOOK_SECRET_FOR_TESTING"
firebase functions:config:set app.url="http://localhost:3000" # Or your production URL
```

To check current config:
`firebase functions:config:get`

These variables will be available in your Cloud Functions via `functions.config()`.

### 7. Install Function Dependencies

Navigate to the `functions` directory and install dependencies:
`cd functions`
`npm install`
`cd ..`

### 8. Firestore Security Rules and Indexes

*   The `firestore.rules` file contains basic security rules. Review and customize them according to your application's exact needs.
*   The `firestore.indexes.json` file is for composite indexes. As you develop queries, Firestore might suggest creating indexes in the Firebase Console; you can then transfer these definitions to this file.

### 9. Storage Security Rules

*   The `storage.rules` file contains basic rules. Adjust as needed.

## Development

### Frontend (Next.js)
`npm run dev`

### Cloud Functions (Local Emulation)
It's highly recommended to use Firebase Emulators for local development of Cloud Functions.
1.  Install emulators: `firebase setup:emulators:functions` (and others like firestore, auth, storage if needed).
2.  Start emulators: `firebase emulators:start`
3.  Your functions will be available locally. Callable functions can be tested from your frontend running on `localhost:3000`.

## Deployment

1.  **Build your Next.js app (if deploying static/SPA to Firebase Hosting):**
    `npm run build`
    (This command might output to an `out` folder, ensure your `firebase.json` hosting public directory points there).

2.  **Deploy to Firebase:**
    *   To deploy everything: `firebase deploy`
    *   To deploy only functions: `firebase deploy --only functions`
    *   To deploy only hosting: `firebase deploy --only hosting`
    *   To deploy only Firestore rules: `firebase deploy --only firestore:rules`
    *   To deploy only Storage rules: `firebase deploy --only storage`

## Connecting Frontend to Firebase Backend

The Firebase SDK is initialized in `src/lib/firebase/firebase.ts`. You can import `auth`, `db`, `storage` from this file into your React components and pages.

**Example: Using Auth**
```tsx
import { useEffect, useState } from 'react';
import { onAuthUserChanged, signInWithGoogle, signOut, type AppUser } from '@/lib/firebase/auth';

function MyComponent() {
  const [user, setUser] = useState<AppUser | null>(null);

  useEffect(() => {
    const unsubscribe = onAuthUserChanged(setUser);
    return () => unsubscribe(); // Cleanup subscription on unmount
  }, []);

  if (user) {
    return (
      <div>
        <p>Welcome, {user.displayName || user.email}!</p>
        <p>Role: {user.role || 'Not set'}</p>
        <button onClick={signOut}>Sign Out</button>
      </div>
    );
  }
  return <button onClick={signInWithGoogle}>Sign in with Google</button>;
}
```

**Example: Using Firestore**
```tsx
import { useEffect, useState } from 'react';
import { getUserProfile, updateUserProfile, type UserProfile } from '@/lib/firebase/firestore';
import { auth } from '@/lib/firebase/firebase'; // For current user

function UserProfileComponent() {
  const [profile, setProfile] = useState<UserProfile | null>(null);
  const currentUser = auth.currentUser;

  useEffect(() => {
    if (currentUser) {
      getUserProfile(currentUser.uid).then(setProfile);
    }
  }, [currentUser]);

  const handleUpdatePreference = async (style: string) => {
    if (currentUser && profile) {
      await updateUserProfile(currentUser.uid, { preferences: { ...profile.preferences, learningStyle: style } });
      // Re-fetch or update local state
      const updatedProfile = await getUserProfile(currentUser.uid);
      setProfile(updatedProfile);
    }
  };
  // ... render profile and update button
}
```

## Genkit AI Flows
This setup focuses on traditional Firebase Cloud Functions. If you are using Genkit for your AI logic:
*   Your Genkit flows defined in `src/ai/flows/` would typically be invoked from these Firebase Cloud Functions.
*   The `functions/src/aiTutor.ts` is scaffolded to show how you might call a Genkit flow.
*   Ensure your Genkit plugins (like `@genkit-ai/firebase` and your AI model plugin like `@genkit-ai/googleai`) are correctly configured in your Cloud Functions environment.

This provides a solid foundation. You'll need to fill in the specific logic for your AI interactions, Stripe payment processing, and detailed UI connections.
